<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <!-- Force landscape orientation on mobile -->
  <meta name="screen-orientation" content="landscape">
  <!-- Mobile app meta tags - enables "Add to Home Screen" fullscreen mode -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <!-- PWA Manifest for fullscreen support -->
  <link rel="manifest" href="/manifest.json">
  <title>Bine & Chalk</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      height: 100%;
      overflow: hidden;
      background-color: #000;
    }

    body {
      /* Use all viewport height variants for maximum compatibility */
      min-height: 100vh;
      min-height: 100dvh;
      min-height: -webkit-fill-available;
      height: 100%;
      overflow: hidden;
      touch-action: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      background-color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Arial', sans-serif;
      /* Handle safe areas (notches, status bars) */
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    #game-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #000;
      /* Extend into safe areas */
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    #game-canvas {
      display: block;
      background-color: #f5e6d3;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
      /* Default: constrained size for desktop */
      width: 100%;
      max-width: 1280px;
      height: auto;
      aspect-ratio: 1280 / 720;
    }

    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #3d2914;
      font-size: 24px;
      font-weight: bold;
    }

    .hidden {
      display: none !important;
    }

    /* Fullscreen prompt overlay for mobile */
    #fullscreen-prompt {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      text-align: center;
      padding: 20px;
      cursor: pointer;
    }

    #fullscreen-prompt .prompt-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    #fullscreen-prompt .prompt-text {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    #fullscreen-prompt .prompt-subtext {
      font-size: 14px;
      opacity: 0.7;
      margin-bottom: 20px;
    }

    #fullscreen-prompt .prompt-button {
      background: linear-gradient(180deg, #4CAF50, #388E3C);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }

    #fullscreen-prompt .skip-link {
      margin-top: 20px;
      font-size: 12px;
      opacity: 0.5;
      text-decoration: underline;
      cursor: pointer;
    }

    /* Rotate device overlay - shown in portrait mode on mobile */
    #rotate-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      height: 100dvh;
      background-color: #000;
      z-index: 9999;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      text-align: center;
      padding: 20px;
    }

    #rotate-overlay .rotate-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: rotate-hint 2s ease-in-out infinite;
    }

    #rotate-overlay .rotate-text {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    #rotate-overlay .rotate-subtext {
      font-size: 16px;
      opacity: 0.7;
    }

    @keyframes rotate-hint {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-15deg); }
      75% { transform: rotate(15deg); }
    }

    /* Mobile portrait mode - show rotate overlay */
    @media screen and (max-width: 900px) and (orientation: portrait) {
      #rotate-overlay {
        display: flex;
      }

      #game-container {
        opacity: 0;
        pointer-events: none;
      }

      #fullscreen-prompt {
        display: none !important;
      }
    }

    /* Mobile landscape mode - FULL SCREEN game */
    @media screen and (max-width: 900px) and (orientation: landscape) {
      html, body {
        width: 100vw;
        height: 100vh;
        height: 100dvh;
        height: -webkit-fill-available;
        overflow: hidden;
        padding: 0;
        margin: 0;
      }

      body {
        /* Remove safe area padding in landscape - we want edge to edge */
        padding: 0;
      }

      #game-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        height: 100dvh;
        height: -webkit-fill-available;
        padding: 0;
        margin: 0;
      }

      #game-canvas {
        /* Fill entire screen in mobile landscape */
        width: 100vw !important;
        height: 100vh !important;
        height: 100dvh !important;
        height: -webkit-fill-available !important;
        max-width: none !important;
        max-height: none !important;
        aspect-ratio: auto !important;
        object-fit: fill;
      }
    }

    /* When in actual fullscreen mode */
    :fullscreen #game-container,
    :-webkit-full-screen #game-container,
    :-moz-full-screen #game-container {
      padding: 0;
    }

    :fullscreen #game-canvas,
    :-webkit-full-screen #game-canvas,
    :-moz-full-screen #game-canvas {
      width: 100vw !important;
      height: 100vh !important;
      max-width: none !important;
      max-height: none !important;
    }

    /* Hide fullscreen prompt when in fullscreen */
    :fullscreen #fullscreen-prompt,
    :-webkit-full-screen #fullscreen-prompt,
    :-moz-full-screen #fullscreen-prompt {
      display: none !important;
    }

    /* Standalone mode (PWA added to home screen) */
    @media all and (display-mode: standalone) {
      #fullscreen-prompt {
        display: none !important;
      }

      #game-canvas {
        width: 100vw !important;
        height: 100vh !important;
        max-width: none !important;
        max-height: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Fullscreen prompt overlay for mobile -->
  <div id="fullscreen-prompt">
    <div class="prompt-icon">ðŸŽ®</div>
    <div class="prompt-text">TAP FOR FULLSCREEN</div>
    <div class="prompt-subtext">Play without the address bar</div>
    <button class="prompt-button" id="fullscreen-btn">GO FULLSCREEN</button>
    <div class="skip-link" id="skip-fullscreen">Skip (play with address bar)</div>
  </div>

  <!-- Rotate device overlay for portrait mode -->
  <div id="rotate-overlay">
    <div class="rotate-icon">ðŸ“±</div>
    <div class="rotate-text">Please Rotate Your Device</div>
    <div class="rotate-subtext">This game is best played in landscape mode</div>
  </div>

  <div id="game-container">
    <canvas id="game-canvas"></canvas>
    <div id="loading">Loading Bine & Chalk...</div>
  </div>

  <script>
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                         window.navigator.standalone === true;

    // Check if we're in fullscreen mode
    function isFullscreen() {
      return !!(document.fullscreenElement || document.webkitFullscreenElement ||
                document.mozFullScreenElement || document.msFullscreenElement);
    }

    // Enter fullscreen mode
    function enterFullscreen() {
      const elem = document.documentElement;

      const requestFullscreen = elem.requestFullscreen ||
                                elem.webkitRequestFullscreen ||
                                elem.mozRequestFullScreen ||
                                elem.msRequestFullscreen;

      if (requestFullscreen) {
        requestFullscreen.call(elem, { navigationUI: 'hide' })
          .then(() => {
            hideFullscreenPrompt();
            lockLandscape();
          })
          .catch((err) => {
            console.log('Fullscreen request failed:', err);
            // On iOS, try the scroll trick instead
            if (isIOS) {
              hideURLBarWithScroll();
              hideFullscreenPrompt();
            }
          });
      } else if (isIOS) {
        // iOS doesn't support fullscreen API well - use scroll trick
        hideURLBarWithScroll();
        hideFullscreenPrompt();
      }
    }

    // iOS scroll trick to minimize URL bar
    function hideURLBarWithScroll() {
      if (!isMobile) return;

      // Set height slightly larger to enable scroll
      document.body.style.height = 'calc(100vh + 1px)';
      document.body.style.overflow = 'auto';

      // Scroll down to hide URL bar
      setTimeout(() => {
        window.scrollTo(0, 1);

        // Restore after scroll
        setTimeout(() => {
          document.body.style.height = '100dvh';
          document.body.style.overflow = 'hidden';
          window.scrollTo(0, 0);
        }, 100);
      }, 50);
    }

    // Lock to landscape orientation
    function lockLandscape() {
      if (!isMobile) return;

      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock('landscape').catch(() => {
          // Orientation lock failed - normal on iOS
        });
      }
    }

    // Show fullscreen prompt
    function showFullscreenPrompt() {
      const prompt = document.getElementById('fullscreen-prompt');
      if (prompt && isMobile && !isStandalone && !isFullscreen()) {
        prompt.style.display = 'flex';
      }
    }

    // Hide fullscreen prompt
    function hideFullscreenPrompt() {
      const prompt = document.getElementById('fullscreen-prompt');
      if (prompt) {
        prompt.style.display = 'none';
      }
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      const skipBtn = document.getElementById('skip-fullscreen');
      const fullscreenPrompt = document.getElementById('fullscreen-prompt');

      if (isMobile && !isStandalone) {
        // Show fullscreen prompt after a short delay
        setTimeout(showFullscreenPrompt, 500);

        // Fullscreen button click
        if (fullscreenBtn) {
          fullscreenBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            enterFullscreen();
          });

          fullscreenBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            enterFullscreen();
          });
        }

        // Skip button
        if (skipBtn) {
          skipBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            hideFullscreenPrompt();
            hideURLBarWithScroll();
          });

          skipBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            hideFullscreenPrompt();
            hideURLBarWithScroll();
          });
        }

        // Tap anywhere on prompt to go fullscreen
        if (fullscreenPrompt) {
          fullscreenPrompt.addEventListener('click', (e) => {
            if (e.target === fullscreenPrompt) {
              enterFullscreen();
            }
          });
        }

        // Lock landscape
        lockLandscape();
      } else {
        // Desktop or standalone mode - hide prompt
        hideFullscreenPrompt();
      }
    });

    // Handle fullscreen change
    document.addEventListener('fullscreenchange', () => {
      if (isFullscreen()) {
        hideFullscreenPrompt();
      }
    });
    document.addEventListener('webkitfullscreenchange', () => {
      if (isFullscreen()) {
        hideFullscreenPrompt();
      }
    });

    // Re-hide URL bar on orientation change
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        if (isMobile && !isFullscreen() && !isStandalone) {
          hideURLBarWithScroll();
        }
      }, 300);
    });

    // Handle resize
    window.addEventListener('resize', () => {
      if (isMobile) {
        const canvas = document.getElementById('game-canvas');
        if (canvas) {
          // Force recalculation of canvas size
          canvas.style.height = '100dvh';
        }
      }
    });
  </script>

  <script type="module" src="/src/main.js"></script>
</body>
</html>
